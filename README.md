# Telegram bot для сотрудников студии йоги, дополняющий crm системы fitbase.

## Функции:
### I Создание актов зарплаты по отчетам из fitbase
Поддерживаются 2 вида отчётов, определяются автоматически:
#### 1. Отчёт по прадажам.
Формируются зарплатные акты для сотрудников с ролью "Администратор". На
основании графика работы сотрудников и часовой ставки рассчитывается оклад. На
основании суммы персональных продаж и фиксированного процента рассчитывается
премиальная часть. \
[(пример)](examples/admins_report.pdf)

#### 2. История начислений зарплат тренеров
Формируются зарплатные акты для сотрудников с ролью "Тренер". Начисления
группируются по названию и сумме.\
[(пример)](examples/trainers_report.pdf)

### II Уведомление кассира о входящей онлайн оплате
Отправка уведомлений о поступлении онлайн оплаты. Уведомления, приходящие на
e-mail обрабатываются и пересылаются в телеграм. После оформления фискального
чека кассир удаляет сообщение кнопкой `Чек готов`. Данная версия работает с
письмами от сервиса CloudPayments.\
![check.png](examples/cash_receipt.png?raw=true)


### III Просмотр графика работы администраторов
Для пользователей с ролью "Администратор" доступен просмотр собственного графика.\
![admin_schedule.png](examples/admin_schedule.png?raw=true)\
Для пользователя "stuff" - график всех сотрудников.\
![admin_schedule.png](examples/full_schedule.png?raw=true)

## Установка зависимостей:
```shell
sudo apt update && sudo apt upgrade -y
sudo apt install git
```

## Переменные окружения:
- `TELEGRAM_TOKEN` - токен телеграм бота;

- `REDIS_HOST` - адрес для подключения redis, по умолчанию 127.0.0.1;
- `REDIS_PORT` - порт для подключения redis, по умолчанию 6379;

- `IMAP_SSL_HOST` - imap сервер;
- `IMAP_USERNAME` - адрес почтового ящика;
- `IMAP_PASSWORD` - пароль почтового ящика;
- `IMAP_FROM_EMAIL` - адрес отправителя писем;
- `INTERVAL` - интервал проверки почты.

## Установка приложения:
- Клонируем;
```shell
git clone https://github.com/grachevvladislav/report-generator.git
```
- В папке проекта создать `.env` (описание выше);
- Сделать исполняемым скрипт certbot и скрипт запуска;
```shell
sudo chmod +x init-letsencrypt.sh
sudo chmod +x pull_new_image.sh
```
- Закомментировать строки касающиеся SSL;
```shell
backend/files/templates/default.conf.template
```
- Запустить стартовый скрипт;
```shell
sudo ./pull_new_image.sh
```
- Запустить генерацию сертификата;
```shell
sudo ./init-letsencrypt.sh
```
- Разкомментировать строки обратно;
```shell
backend/files/templates/default.conf.template
```
- Снова запустить стартовый скрипт или перезапустить nginx;
```shell
sudo ./pull_new_image.sh
```
