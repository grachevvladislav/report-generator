# Telegram bot для сотрудников студии йоги, дополняющий crm системы fitbase.

## Функции:
### I Создание актов зарплаты по отчетам из fitbase
Поддерживаются 2 вида отчётов, определяются автоматически:
#### 1. Отчёт по прадажам.
Формируются зарплатные акты для сотрудников с ролью "Администратор". На
основании графика работы сотрудников и часовой ставки рассчитывается оклад. На
основании суммы персональных продаж и фиксированного процента рассчитывается
премиальная часть. \
[(пример)](examples/admins_report.pdf)

#### 2. История начислений зарплат тренеров
Формируются зарплатные акты для сотрудников с ролью "Тренер". Начисления
группируются по названию и сумме.\
[(пример)](examples/trainers_report.pdf)

### II Уведомление кассира о входящей онлайн оплате
Отправка уведомлений о поступлении онлайн оплаты. Уведомления, приходящие на
e-mail обрабатываются и пересылаются в телеграм. После оформления фискального
чека кассир удаляет сообщение кнопкой `Чек готов`. Данная версия работает с
письмами от сервиса CloudPayments.\
![check.png](examples/cash_receipt.png?raw=true)


### III Просмотр графика работы администраторов
Для пользователей с ролью "Администратор" доступен просмотр собственного графика.\
![admin_schedule.png](examples/admin_schedule.png?raw=true)\
Для пользователя "stuff" - график всех сотрудников.\
![admin_schedule.png](examples/full_schedule.png?raw=true)

## Хранение информации:
**Для хранения информации используются две таблицы google sheet.**
1. График работы [(пример)](examples/administrator_db.xlsx)
- `Имя листа` - год;
- `Дата` - дата в формате DD.MM.YYYY;
- `Администратор` - Полное ФИО сотрудника;
- `Время` - Рабочее время в часах. Допускается разделитель `.` или `,`. Если
поле пустое — используется значение по умолчанию, задаваемое константой.

| - | A          | B                    | C     |
|---|------------|----------------------|-------|
| 1 | Дата       | Администратор        | Время |
| 2 | 01.01.2024 | Иванов Иван Иванович | 8,5   |
| 3 | 02.01.2024 | Петров Петр Петрович |       |

2. Настройки и персональная информация [(пример)](examples/bot_settings.xlsx)\
Лист "document_counter" - счётчик актов в ячейке `A1`. Хранит номер последнего
акта. Обновляется при подтверждении правильности формирования актов.

| - | A          |
|---|------------|
| 1 | 1          |

Лист "employees" - Информация о сотрудниках.

| - | A                    | B    | C                                          | D                    | E                  | F      | G                     | H                | I              | J           | K             | L      |
|---|----------------------|------|--------------------------------------------|----------------------|--------------------|--------|-----------------------|------------------|----------------|-------------|---------------|--------|
| 1 | fio                  | inn  | address                                    | checking_account     | bank               | bik    | correspondent_account | agreement_number | agreement_date | telegram_id | role          | active |
| 2 | Иванов Иван Иванович | 1234 | ул. Борисовские Пруды, 26, корп. 2, Москва | 98765432123456788765 | АО «Альфа-Банк»    | 775676 | 0987654321            | 01               | 19.01.2024     | 700         | Администратор | Да     |
| 3 | Петров Петр Петрович | 5678 | ул. Верхние Поля, 32, корп. 1, Москва      | 34567876543456787654 | АО «Тинькофф Банк» | 576576 | 9876543               | 02               | 19.01.2024     |             | Тренер        | Да     |

- `fio` - ФИО сотрудника. Заполняется строго полностью;
- `telegram_id` - id сотрудника (в текущей версии актуально только для
- администраторов);
- `inn` - ИНН, используется при составлении акта;
- `address` - адрес прописки, используется при составлении акта;
- `checking_account` - номер счёта, используется при составлении акта;
- `bank` - название банка, используется при составлении акта;
- `bik` - БИК банка, используется при составлении акта;
- `correspondent_account` - кор. счёт, используется при составлении акта;
- `agreement_number` - номер договора, используется при составлении акта;
- `agreement_date` - дата подписания договора, используется при составлении акта;
- `telegram_id` - id телеграм сотрудника;
- `role` - может иметь значения `Администратор`, `Тренер` или `stuff`.
Используется для выбора режима работы бота с сотрудником.;
- `active` - может иметь значения `Да` или `Нет`. Используется для полного
исключения сотрудника из обработки.

Лист "constants" - Константы

| - | A                         | B                 | C                              | D                                                                                                                                                                        | E                | F                               | G          |
|---|---------------------------|-------------------|--------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------|------------------|---------------------------------|------------|
| 1 | Рабочее время поумолчанию | Процент от продаж | Часовая ставка администраторов | Реквизиты заказчика                                                                                                                                                      | Заказчик коротко | Типы занятий по умолчанию       | id кассира |
| 2 | 11.5                      | 5                 | 200                            | ИП Иванов Иван Иванович, ОГРНИП: 4635655466, ИНН: 56564564566, 45656456 г. Москва, ул. Пушкина, д.5, кв.3, р/с 65474677567567657577 в банке АО "ТИНЬКОФФ БАНК", БИК 1234 | Иванов И. И.     | Групповое занятие 1,5 часа$1200 | 0987654321 |
| 3 |                           |                   |                                |                                                                                                                                                                          |                  | Групповое занятие 55 минут$800  |            |

- `Рабочее время поумолчанию` - Используется, если в рабочем графике не указанно
количество отработанных часов. Целое или дробное число;
- `Процент от продаж` - процент от личных продаж сотрудника, используется для
расчёта премиальной части зарплаты. Целое или дробное число в процентах;
- `Часовая ставка администраторов` - стоимость человеко-часа. Целое или дробное
число;
- `Реквизиты заказчика` - Полные данные заказчика в акте. Целое или дробное
число. Допустимо любое значение;
- `Заказчик коротко` - Фамилия и инициалы заказчика. Допустимо любое значение.
- `Типы занятий по умолчанию` - Список топов занятий, обязательных для указания
в акте. Формат "Наименование$Цена";
- `id кассира` - id телеграм для получения чеков онлайн оплаты.

## Установка приложения:
1. Создать описанные выше таблицы, получить приватный ключ для доступа через
api.
2. Поместить приватный ключ в рабочую папку на сервере. Имя файла:
`inspired-alcove.json`.
3. Скопировать из репозитория файлы: `docker-compose.yml`, `redis.conf`,
`pull_new_image.sh`.
4. Создать файл `.env` со следующими переменными[(пример)](examples/dot_env):
- `TELEGRAM_TOKEN` - токен телеграм бота;
- `BOT_SETTINGS_URL` - адрес таблицы с настройками;
- `SCHEDULE_URL` - адрес таблицы с расписанием;
- `REDIS_HOST` - адрес для подключения redis, по умолчанию 127.0.0.1;
- `REDIS_PORT` - порт для подключения redis, по умолчанию 6379;
- `IMAP_SSL_HOST` - imap сервер;
- `IMAP_USERNAME` - адрес почтового ящика;
- `IMAP_PASSWORD` - пароль почтового ящика;
- `IMAP_FROM_EMAIL` - адрес отправителя писем;
- `INTERVAL` - интервал проверки почты.
5. Сделать файл скрипта исполняемым `sudo chmod +x pull_new_image.sh`.
6. Запустить стартовый скрипт `sudo ./pull_new_image.sh`.
